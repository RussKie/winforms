// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
// See the LICENSE file in the project root for more information.

using System.Text;

namespace System.Windows.Forms
{
    internal class ProjectConfigurationInitializeGenerator
    {
        public static string GenerateInitialize(string projectNamespace, ProjectConfigurationInfo projectConfig)
        {
            bool visualStylesEnabled = GetVisualStylesEnabled(projectConfig);
            string? defaultFont = GetDefaultFont(projectConfig);
            string highDpiMode = GetHighDpiMode(projectConfig);

            const string indent = "            ";

            StringBuilder sb = new();
            sb.AppendFormat(
@"// <auto-generated />

using System.Drawing;
using System.Windows.Forms;

namespace {0}", projectNamespace);

            sb.AppendLine(@"{
    /// <summary>
    ///  Bootstrap the application configuration.
    /// </summary>
    internal static partial class ProjectConfiguration
    {
        /// <summary>
        ///  Bootstrap the application as follows:
        ///  <code>");

            if (visualStylesEnabled)
            {
                sb.AppendLine("        ///  Application.EnableVisualStyles();");
            }

            if (defaultFont is not null)
            {
                sb.AppendLine($"        ///  Application.SetDefaultFont({defaultFont});");
            }

            if (visualStylesEnabled)
            {
                sb.AppendLine($"        ///  Application.SetHighDpiMode(HighDpiMode.{highDpiMode});");
            }

            sb.AppendLine(@"        /// </code>
        /// </summary>
        public static void Initialize()
        {");

            if (visualStylesEnabled)
            {
                sb.AppendLine($"{indent}Application.EnableVisualStyles();");
            }

            if (defaultFont is not null)
            {
                sb.AppendLine($"{indent}Application.SetDefaultFont({defaultFont});");
            }

            sb.AppendLine($"{indent}Application.SetHighDpiMode(HighDpiMode.{highDpiMode});");

            sb.AppendLine(@"        }
    }
}");

            return sb.ToString();

            static string? GetDefaultFont(ProjectConfigurationInfo projectConfig)
            {
                if (!string.IsNullOrWhiteSpace(projectConfig.FontFamily) || projectConfig.FontSize.HasValue)
                {
                    string fontFamily = string.IsNullOrWhiteSpace(projectConfig.FontFamily)
                        ? "Control.DefaultFont.FontFamily"
                        : $"new FontFamily(\"{projectConfig.FontFamily}\")";
                    // TODO: ensure positive, within certain range
                    float fontSize = projectConfig.FontSize ?? 9f;

                    return $"new Font({fontFamily}, {fontSize}f)";
                }

                return null;
            }

            static string GetHighDpiMode(ProjectConfigurationInfo projectConfig)
            {
                if (!string.IsNullOrWhiteSpace(projectConfig.HighDpiMode)
                    && Enum.TryParse(projectConfig.HighDpiMode, ignoreCase: true, out HighDpiMode highDpiMode))
                {
                    return highDpiMode.ToString();
                }
                else
                {
                    return "PerMonitorV2";
                }
            }

            static bool GetVisualStylesEnabled(ProjectConfigurationInfo projectConfig)
                => projectConfig.EnableVisualStyles is null
                || (bool.TryParse(projectConfig.EnableVisualStyles, out bool enableVisualStyles) && enableVisualStyles);
        }
    }
}
